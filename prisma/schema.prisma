generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

model ConnectInstallation {
  id                    Int                @id @default(autoincrement())
  key                   String
  clientKey             String             @unique @map("client_key")
  sharedSecret          String             @map("shared_secret")
  baseUrl               String             @map("base_url")
  displayUrl            String             @map("display_url")
  FigmaTeam             FigmaTeam[]
  AssociatedFigmaDesign AssociatedFigmaDesign[]

  @@map("connect_installation")
}

model AssociatedFigmaDesign {
  id                    Int    @id @default(autoincrement())
  fileKey               String @map("file_key")
  // Prisma does not support nullable columns with the composite indexes
  // https://github.com/prisma/prisma/issues/3197
  nodeId                String @map("node_id")

  connectInstallation   ConnectInstallation @relation(fields: [connectInstallationId], references: [id], onDelete: Cascade, onUpdate: NoAction)
  connectInstallationId Int                 @map("connect_installation_id")

  @@unique([fileKey, nodeId, connectInstallationId])
  @@map("associated_figma_design")
}

model FigmaOAuth2UserCredentials {
  id              Int      @id @default(autoincrement())
  atlassianUserId String   @unique @map("atlassian_user_id")
  accessToken     String   @map("access_token")
  refreshToken    String   @map("refresh_token")
  expiresAt       DateTime @map("expires_at") @db.Timestamptz

  @@map("figma_oauth2_user_credentials")
}

enum FigmaTeamStatus {
  PENDING
  ACTIVE
  PAUSED
  ERROR

  @@map("figma_team_status")
}

model FigmaTeam {
  id                        Int             @id @default(autoincrement())
  webhookId                 String          @unique @map("webhook_id")
  teamId                    String          @map("team_id")
  teamName                  String          @map("team_name")
  // Atlassian user ID of the Figma team admin that configured the webhook
  figmaAdminAtlassianUserId String          @map("figma_admin_atlassian_user_id")
  status                    FigmaTeamStatus

  connectInstallation   ConnectInstallation @relation(fields: [connectInstallationId], references: [id], onDelete: Cascade, onUpdate: NoAction)
  connectInstallationId Int                 @map("connect_installation_id")

  @@unique([teamId, connectInstallationId])
  @@map("figma_team")
}
